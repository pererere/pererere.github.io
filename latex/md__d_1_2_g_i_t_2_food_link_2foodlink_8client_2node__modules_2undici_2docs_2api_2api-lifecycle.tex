\chapter{Client Lifecycle}
\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle}{}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle}\index{Client Lifecycle@{Client Lifecycle}}
\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21224}%
\Hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21224}%


An Undici \doxysectlink{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2_client}{Client}{0} can be best described as a state machine. The following list is a summary of the various state transitions the {\ttfamily Client} will go through in its lifecycle. This document also contains detailed breakdowns of each state.

\begin{quote}
This diagram is not a perfect representation of the undici Client. Since the Client class is not actually implemented as a state-\/machine, actual execution may deviate slightly from what is described below. Consider this as a general resource for understanding the inner workings of the Undici client rather than some kind of formal specification. \end{quote}
\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21225}{}\doxysection{\texorpdfstring{State Transition Overview}{State Transition Overview}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21225}

\begin{DoxyItemize}
\item A {\ttfamily Client} begins in the {\bfseries{idle}} state with no socket connection and no requests in queue.
\begin{DoxyItemize}
\item The {\itshape connect} event transitions the {\ttfamily Client} to the {\bfseries{pending}} state where requests can be queued prior to processing.
\item The {\itshape close} and {\itshape destroy} events transition the {\ttfamily Client} to the {\bfseries{destroyed}} state. Since there are no requests in the queue, the {\itshape close} event immediately transitions to the {\bfseries{destroyed}} state.
\end{DoxyItemize}
\item The {\bfseries{pending}} state indicates the underlying socket connection has been successfully established and requests are queueing.
\begin{DoxyItemize}
\item The {\itshape process} event transitions the {\ttfamily Client} to the {\bfseries{processing}} state where requests are processed.
\item If requests are queued, the {\itshape close} event transitions to the {\bfseries{processing}} state; otherwise, it transitions to the {\bfseries{destroyed}} state.
\item The {\itshape destroy} event transitions to the {\bfseries{destroyed}} state.
\end{DoxyItemize}
\item The {\bfseries{processing}} state initializes to the {\bfseries{processing.\+running}} state.
\begin{DoxyItemize}
\item If the current request requires draining, the {\itshape need\+Drain} event transitions the {\ttfamily Client} into the {\bfseries{processing.\+busy}} state which will return to the {\bfseries{processing.\+running}} state with the {\itshape drain\+Complete} event.
\item After all queued requests are completed, the {\itshape keepalive} event transitions the {\ttfamily Client} back to the {\bfseries{pending}} state. If no requests are queued during the timeout, the {\bfseries{close}} event transitions the {\ttfamily Client} to the {\bfseries{destroyed}} state.
\item If the {\itshape close} event is fired while the {\ttfamily Client} still has queued requests, the {\ttfamily Client} transitions to the {\bfseries{process.\+closing}} state where it will complete all existing requests before firing the {\itshape done} event.
\item The {\itshape done} event gracefully transitions the {\ttfamily Client} to the {\bfseries{destroyed}} state.
\item At any point in time, the {\itshape destroy} event will transition the {\ttfamily Client} from the {\bfseries{processing}} state to the {\bfseries{destroyed}} state, destroying any queued requests.
\end{DoxyItemize}
\item The {\bfseries{destroyed}} state is a final state and the {\ttfamily Client} is no longer functional.
\end{DoxyItemize}



\begin{quote}
The diagram was generated using Mermaid.\+js Live Editor. Modify the state diagram \href{https://mermaid-js.github.io/mermaid-live-editor/\#/edit/eyJjb2RlIjoic3RhdGVEaWFncmFtLXYyXG4gICAgWypdIC0tPiBpZGxlXG4gICAgaWRsZSAtLT4gcGVuZGluZyA6IGNvbm5lY3RcbiAgICBpZGxlIC0tPiBkZXN0cm95ZWQgOiBkZXN0cm95L2Nsb3NlXG4gICAgXG4gICAgcGVuZGluZyAtLT4gaWRsZSA6IHRpbWVvdXRcbiAgICBwZW5kaW5nIC0tPiBkZXN0cm95ZWQgOiBkZXN0cm95XG5cbiAgICBzdGF0ZSBjbG9zZV9mb3JrIDw8Zm9yaz4-XG4gICAgcGVuZGluZyAtLT4gY2xvc2VfZm9yayA6IGNsb3NlXG4gICAgY2xvc2VfZm9yayAtLT4gcHJvY2Vzc2luZ1xuICAgIGNsb3NlX2ZvcmsgLS0-IGRlc3Ryb3llZFxuXG4gICAgcGVuZGluZyAtLT4gcHJvY2Vzc2luZyA6IHByb2Nlc3NcblxuICAgIHByb2Nlc3NpbmcgLS0-IHBlbmRpbmcgOiBrZWVwYWxpdmVcbiAgICBwcm9jZXNzaW5nIC0tPiBkZXN0cm95ZWQgOiBkb25lXG4gICAgcHJvY2Vzc2luZyAtLT4gZGVzdHJveWVkIDogZGVzdHJveVxuXG4gICAgc3RhdGUgcHJvY2Vzc2luZyB7XG4gICAgICAgIHJ1bm5pbmcgLS0-IGJ1c3kgOiBuZWVkRHJhaW5cbiAgICAgICAgYnVzeSAtLT4gcnVubmluZyA6IGRyYWluQ29tcGxldGVcbiAgICAgICAgcnVubmluZyAtLT4gWypdIDoga2VlcGFsaXZlXG4gICAgICAgIHJ1bm5pbmcgLS0-IGNsb3NpbmcgOiBjbG9zZVxuICAgICAgICBjbG9zaW5nIC0tPiBbKl0gOiBkb25lXG4gICAgICAgIFsqXSAtLT4gcnVubmluZ1xuICAgIH1cbiAgICAiLCJtZXJtYWlkIjp7InRoZW1lIjoiYmFzZSJ9LCJ1cGRhdGVFZGl0b3IiOmZhbHNlfQ}{\texttt{ here}} \end{quote}
\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21226}{}\doxysection{\texorpdfstring{State details}{State details}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21226}
\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21227}{}\doxysubsection{\texorpdfstring{idle}{idle}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21227}
The {\bfseries{idle}} state is the initial state of a {\ttfamily Client} instance. While an {\ttfamily origin} is required for instantiating a {\ttfamily Client} instance, the underlying socket connection will not be established until a request is queued using \href{Client.md\#clientdispatchoptions-handlers}{\texttt{ {\ttfamily Client.\+dispatch()}}}. By calling {\ttfamily Client.\+dispatch()} directly or using one of the multiple implementations (\href{Client.md\#clientconnectoptions-callback}{\texttt{ {\ttfamily Client.\+connect()}}}, \href{Client.md\#clientpipelineoptions-handler}{\texttt{ {\ttfamily Client.\+pipeline()}}}, \href{Client.md\#clientrequestoptions-callback}{\texttt{ {\ttfamily Client.\+request()}}}, \href{Client.md\#clientstreamoptions-factory-callback}{\texttt{ {\ttfamily Client.\+stream()}}}, and \href{Client.md\#clientupgradeoptions-callback}{\texttt{ {\ttfamily Client.\+upgrade()}}}), the {\ttfamily Client} instance will transition from {\bfseries{idle}} to \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}pending\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} and then most likely directly to \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}.

Calling \href{Client.md\#clientclosecallback}{\texttt{ {\ttfamily Client.\+close()}}} or \href{Client.md\#clientdestroyerror-callback}{\texttt{ {\ttfamily Client.\+destroy()}}} transitions directly to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}destroyed\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state since the {\ttfamily Client} instance will have no queued requests in this state.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21228}{}\doxysubsection{\texorpdfstring{pending}{pending}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21228}
The {\bfseries{pending}} state signifies a non-\/processing {\ttfamily Client}. Upon entering this state, the {\ttfamily Client} establishes a socket connection and emits the \href{Client.md\#event-connect}{\texttt{ `\textquotesingle{}connect'\`{}}} event signalling a connection was successfully established with the {\ttfamily origin} provided during {\ttfamily Client} instantiation. The internal queue is initially empty, and requests can start queueing.

Calling \href{Client.md\#clientclosecallback}{\texttt{ {\ttfamily Client.\+close()}}} with queued requests, transitions the {\ttfamily Client} to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state. Without queued requests, it transitions to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}destroyed\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state.

Calling \href{Client.md\#clientdestroyerror-callback}{\texttt{ {\ttfamily Client.\+destroy()}}} transitions directly to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}destroyed\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state regardless of existing requests.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21229}{}\doxysubsection{\texorpdfstring{processing}{processing}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21229}
The {\bfseries{processing}} state is a state machine within itself. It initializes to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing.running\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state. The \href{Client.md\#clientdispatchoptions-handlers}{\texttt{ {\ttfamily Client.\+dispatch()}}}, \href{Client.md\#clientclosecallback}{\texttt{ {\ttfamily Client.\+close()}}}, and \href{Client.md\#clientdestroyerror-callback}{\texttt{ {\ttfamily Client.\+destroy()}}} can be called at any time while the {\ttfamily Client} is in this state. {\ttfamily Client.\+dispatch()} will add more requests to the queue while existing requests continue to be processed. {\ttfamily Client.\+close()} will transition to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing.closing\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state. And {\ttfamily Client.\+destroy()} will transition to \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}destroyed\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21230}{}\doxysubsubsection{\texorpdfstring{running}{running}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21230}
In the {\bfseries{processing.\+running}} sub-\/state, queued requests are being processed in a FIFO order. If a request body requires draining, the {\itshape need\+Drain} event transitions to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing.busy\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} sub-\/state. The {\itshape close} event transitions the Client to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}process.closing\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} sub-\/state. If all queued requests are processed and neither \href{Client.md\#clientclosecallback}{\texttt{ {\ttfamily Client.\+close()}}} nor \href{Client.md\#clientdestroyerror-callback}{\texttt{ {\ttfamily Client.\+destroy()}}} are called, then the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} machine will trigger a {\itshape keepalive} event transitioning the {\ttfamily Client} back to the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}pending\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state. During this time, the {\ttfamily Client} is waiting for the socket connection to timeout, and once it does, it triggers the {\itshape timeout} event and transitions to the \doxylink{README.md_idle}{\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}idle\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}} state.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21231}{}\doxysubsubsection{\texorpdfstring{busy}{busy}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21231}
This sub-\/state is only entered when a request body is an instance of \href{https://nodejs.org/api/stream.html}{\texttt{ Stream}} and requires draining. The {\ttfamily Client} cannot process additional requests while in this state and must wait until the currently processing request body is completely drained before transitioning back to \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}processing.running\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21232}{}\doxysubsubsection{\texorpdfstring{closing}{closing}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21232}
This sub-\/state is only entered when a {\ttfamily Client} instance has queued requests and the \href{Client.md\#clientclosecallback}{\texttt{ {\ttfamily Client.\+close()}}} method is called. In this state, the {\ttfamily Client} instance continues to process requests as usual, with the one exception that no additional requests can be queued. Once all of the queued requests are processed, the {\ttfamily Client} will trigger the {\itshape done} event gracefully entering the \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}destroyed\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*} state without an error.\hypertarget{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21233}{}\doxysubsection{\texorpdfstring{destroyed}{destroyed}}\label{md__d_1_2_g_i_t_2_food_link_2foodlink_8client_2node__modules_2undici_2docs_2api_2api-lifecycle_autotoc_md21233}
The {\bfseries{destroyed}} state is a final state for the {\ttfamily Client} instance. Once in this state, a {\ttfamily Client} is nonfunctional. Calling any other {\ttfamily Client} methods will result in an {\ttfamily Client\+Destroyed\+Error}. 