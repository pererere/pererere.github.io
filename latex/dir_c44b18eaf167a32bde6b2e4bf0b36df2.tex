\doxysection{D\+:/\+GIT/\+Food\+Link/foodlink.client/node\+\_\+modules/piscina Directory Reference}
\hypertarget{dir_c44b18eaf167a32bde6b2e4bf0b36df2}{}\label{dir_c44b18eaf167a32bde6b2e4bf0b36df2}\index{D:/GIT/FoodLink/foodlink.client/node\_modules/piscina Directory Reference@{D:/GIT/FoodLink/foodlink.client/node\_modules/piscina Directory Reference}}


\doxysubsection{Detailed Description}
!\mbox{[}Piscina Logo\mbox{]}(\href{https://avatars1.githubusercontent.com/u/65627548?s=200&v=4}{\texttt{ https\+://avatars1.\+githubusercontent.\+com/u/65627548?s=200\&v=4}})\hypertarget{README.md_autotoc_md16238}{}\doxysubsection{\texorpdfstring{piscina -\/ the node.\+js worker pool}{piscina -\/ the node.\+js worker pool}}\label{README.md_autotoc_md16238}



\begin{DoxyItemize}
\item ✔ Fast communication between threads
\item ✔ Covers both fixed-\/task and variable-\/task scenarios
\item ✔ Supports flexible pool sizes
\item ✔ Proper async tracking integration
\item ✔ Tracking statistics for run and wait times
\item ✔ Cancellation Support
\item ✔ Supports enforcing memory resource limits
\item ✔ Supports Common\+JS, ESM, and Type\+Script
\item ✔ Custom task queues
\item ✔ Optional CPU scheduling priorities on Linux
\end{DoxyItemize}

Written in Type\+Script.

For Node.\+js 16.\+x and higher.

MIT Licensed.\hypertarget{README.md_autotoc_md16239}{}\doxysubsubsection{\texorpdfstring{Piscina API}{Piscina API}}\label{README.md_autotoc_md16239}
\hypertarget{README.md_autotoc_md16240}{}\doxysubsubsubsection{\texorpdfstring{Example}{Example}}\label{README.md_autotoc_md16240}
In {\ttfamily main.\+js}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ path\ =\ require('path');}
\DoxyCodeLine{const\ Piscina\ =\ require('piscina');}
\DoxyCodeLine{}
\DoxyCodeLine{const\ piscina\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ filename:\ path.resolve(\_\_dirname,\ 'worker.js')}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{(async\ function()\ \{}
\DoxyCodeLine{\ \ const\ result\ =\ await\ piscina.run(\{\ a:\ 4,\ b:\ 6\ \});}
\DoxyCodeLine{\ \ console.log(result);\ \ //\ Prints\ 10}
\DoxyCodeLine{\})();}

\end{DoxyCode}


In {\ttfamily worker.\+js}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{module.exports\ =\ (\{\ a,\ b\ \})\ =>\ \{}
\DoxyCodeLine{\ \ return\ a\ +\ b;}
\DoxyCodeLine{\};}

\end{DoxyCode}


The worker may also be an async function or may return a Promise\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{\ setTimeout\ \}\ =\ require('timers/promises');}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ async\ (\{\ a,\ b\ \})\ =>\ \{}
\DoxyCodeLine{\ \ //\ Fake\ some\ async\ activity}
\DoxyCodeLine{\ \ await\ setTimeout(100);}
\DoxyCodeLine{\ \ return\ a\ +\ b;}
\DoxyCodeLine{\};}

\end{DoxyCode}


ESM is also supported for both Piscina and workers\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{import\ \{\ Piscina\ \}\ from\ 'piscina';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ piscina\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ //\ The\ URL\ must\ be\ a\ file://\ URL}
\DoxyCodeLine{\ \ filename:\ new\ URL('./worker.mjs',\ import.meta.url).href}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{const\ result\ =\ await\ piscina.run(\{\ a:\ 4,\ b:\ 6\ \});}
\DoxyCodeLine{console.log(result);\ //\ Prints\ 10}

\end{DoxyCode}


In {\ttfamily worker.\+mjs}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{export\ default\ (\{\ a,\ b\ \})\ =>\ \{}
\DoxyCodeLine{\ \ return\ a\ +\ b;}
\DoxyCodeLine{\};}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16241}{}\doxysubsubsubsection{\texorpdfstring{Exporting multiple worker functions}{Exporting multiple worker functions}}\label{README.md_autotoc_md16241}
A single worker file may export multiple named handler functions.


\begin{DoxyCode}{0}
\DoxyCodeLine{'use\ strict';}
\DoxyCodeLine{}
\DoxyCodeLine{function\ add(\{\ a,\ b\ \})\ \{\ return\ a\ +\ b;\ \}}
\DoxyCodeLine{}
\DoxyCodeLine{function\ multiply(\{\ a,\ b\ \})\ \{\ return\ a\ *\ b;\ \}}
\DoxyCodeLine{}
\DoxyCodeLine{add.add\ =\ add;}
\DoxyCodeLine{add.multiply\ =\ multiply;}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ add;}

\end{DoxyCode}


The export to target can then be specified when the task is submitted\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{'use\ strict';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ Piscina\ =\ require('piscina');}
\DoxyCodeLine{const\ \{\ resolve\ \}\ =\ require('path');}
\DoxyCodeLine{}
\DoxyCodeLine{const\ piscina\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ filename:\ resolve(\_\_dirname,\ 'worker.js')}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{(async\ function()\ \{}
\DoxyCodeLine{\ \ const\ res\ =\ await\ Promise.all([}
\DoxyCodeLine{\ \ \ \ piscina.run(\{\ a:\ 4,\ b:\ 6\ \},\ \{\ name:\ 'add'\ \}),}
\DoxyCodeLine{\ \ \ \ piscina.run(\{\ a:\ 4,\ b:\ 6\ \},\ \{\ name:\ 'multiply'\ \})}
\DoxyCodeLine{\ \ ]);}
\DoxyCodeLine{\})();}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16242}{}\doxysubsubsubsection{\texorpdfstring{Cancelable Tasks}{Cancelable Tasks}}\label{README.md_autotoc_md16242}
Submitted tasks may be canceled using either an {\ttfamily Abort\+Controller} or an {\ttfamily Event\+Emitter}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{'use\ strict';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ Piscina\ =\ require('piscina');}
\DoxyCodeLine{const\ \{\ AbortController\ \}\ =\ require('abort-\/controller');}
\DoxyCodeLine{const\ \{\ resolve\ \}\ =\ require('path');}
\DoxyCodeLine{}
\DoxyCodeLine{const\ piscina\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ filename:\ resolve(\_\_dirname,\ 'worker.js')}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{(async\ function()\ \{}
\DoxyCodeLine{\ \ const\ abortController\ =\ new\ AbortController();}
\DoxyCodeLine{\ \ try\ \{}
\DoxyCodeLine{\ \ \ \ const\ \{\ signal\ \}\ =\ abortController;}
\DoxyCodeLine{\ \ \ \ const\ task\ =\ piscina.run(\{\ a:\ 4,\ b:\ 6\ \},\ \{\ signal\ \});}
\DoxyCodeLine{\ \ \ \ abortController.abort();}
\DoxyCodeLine{\ \ \ \ await\ task;}
\DoxyCodeLine{\ \ \}\ catch\ (err)\ \{}
\DoxyCodeLine{\ \ \ \ console.log('The\ task\ was\ canceled');}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\})();}

\end{DoxyCode}


To use {\ttfamily Abort\+Controller}, you will need to {\ttfamily npm i abort-\/controller} (or {\ttfamily yarn add abort-\/controller}).

(In Node.\+js 15.\+0.\+0 or higher, there is a new built-\/in {\ttfamily Abort\+Controller} implementation that can be used here as well.)

Alternatively, any {\ttfamily Event\+Emitter} that emits an `\textquotesingle{}abort'\`{} event may be used as an abort controller\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{'use\ strict';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ Piscina\ =\ require('piscina');}
\DoxyCodeLine{const\ EventEmitter\ =\ require('events');}
\DoxyCodeLine{const\ \{\ resolve\ \}\ =\ require('path');}
\DoxyCodeLine{}
\DoxyCodeLine{const\ piscina\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ filename:\ resolve(\_\_dirname,\ 'worker.js')}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{(async\ function()\ \{}
\DoxyCodeLine{\ \ const\ ee\ =\ new\ EventEmitter();}
\DoxyCodeLine{\ \ try\ \{}
\DoxyCodeLine{\ \ \ \ const\ task\ =\ piscina.run(\{\ a:\ 4,\ b:\ 6\ \},\ \{\ signal:\ ee\ \});}
\DoxyCodeLine{\ \ \ \ ee.emit('abort');}
\DoxyCodeLine{\ \ \ \ await\ task;}
\DoxyCodeLine{\ \ \}\ catch\ (err)\ \{}
\DoxyCodeLine{\ \ \ \ console.log('The\ task\ was\ canceled');}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\})();}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16243}{}\doxysubsubsubsection{\texorpdfstring{Delaying Availability of Workers}{Delaying Availability of Workers}}\label{README.md_autotoc_md16243}
A worker thread will not be made available to process tasks until Piscina determines that it is "{}ready"{}. By default, a worker is ready as soon as Piscina loads it and acquires a reference to the exported handler function.

There may be times when the availability of a worker may need to be delayed longer while the worker initializes any resources it may need to operate. To support this case, the worker module may export a {\ttfamily Promise} that resolves the handler function as opposed to exporting the function directly\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{async\ function\ initialize()\ \{}
\DoxyCodeLine{\ \ await\ someAsyncInitializationActivity();}
\DoxyCodeLine{\ \ return\ (\{\ a,\ b\ \})\ =>\ a\ +\ b;}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ initialize();}

\end{DoxyCode}


Piscina will await the resolution of the exported Promise before marking the worker thread available.\hypertarget{README.md_autotoc_md16244}{}\doxysubsubsubsection{\texorpdfstring{Backpressure}{Backpressure}}\label{README.md_autotoc_md16244}
When the {\ttfamily max\+Queue} option is set, once the {\ttfamily Piscina} queue is full, no additional tasks may be submitted until the queue size falls below the limit. The `\textquotesingle{}drain'\`{} event may be used to receive notification when the queue is empty and all tasks have been submitted to workers for processing.

Example\+: Using a Node.\+js stream to feed a Piscina worker pool\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{'use\ strict';}
\DoxyCodeLine{}
\DoxyCodeLine{const\ \{\ resolve\ \}\ =\ require('path');}
\DoxyCodeLine{const\ Pool\ =\ require('../..');}
\DoxyCodeLine{}
\DoxyCodeLine{const\ pool\ =\ new\ Pool(\{}
\DoxyCodeLine{\ \ filename:\ resolve(\_\_dirname,\ 'worker.js'),}
\DoxyCodeLine{\ \ maxQueue:\ 'auto'}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{const\ stream\ =\ getStreamSomehow();}
\DoxyCodeLine{stream.setEncoding('utf8');}
\DoxyCodeLine{}
\DoxyCodeLine{pool.on('drain',\ ()\ =>\ \{}
\DoxyCodeLine{\ \ if\ (stream.isPaused())\ \{}
\DoxyCodeLine{\ \ \ \ console.log('resuming...',\ counter,\ pool.queueSize);}
\DoxyCodeLine{\ \ \ \ stream.resume();}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\});}
\DoxyCodeLine{}
\DoxyCodeLine{stream}
\DoxyCodeLine{\ \ .on('data',\ (data)\ =>\ \{}
\DoxyCodeLine{\ \ \ \ pool.run(data);}
\DoxyCodeLine{\ \ \ \ if\ (pool.queueSize\ ===\ pool.options.maxQueue)\ \{}
\DoxyCodeLine{\ \ \ \ \ \ console.log('pausing...',\ counter,\ pool.queueSize);}
\DoxyCodeLine{\ \ \ \ \ \ stream.pause();}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ \})}
\DoxyCodeLine{\ \ .on('error',\ console.error)}
\DoxyCodeLine{\ \ .on('end',\ ()\ =>\ \{}
\DoxyCodeLine{\ \ \ \ console.log('done');}
\DoxyCodeLine{\ \ \});}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16245}{}\doxysubsubsubsection{\texorpdfstring{Out of scope asynchronous code}{Out of scope asynchronous code}}\label{README.md_autotoc_md16245}
A worker thread is {\bfseries{only}} active until the moment it returns a result, it can be a result of a synchronous call or a Promise that will be fulfilled/rejected in the future. Once this is done, Piscina will wait for stdout and stderr to be flushed, and then pause the worker\textquotesingle{}s event-\/loop until the next call. If async code is scheduled without being awaited before returning since Piscina has no way of detecting this, that code execution will be resumed on the next call. Thus, it is highly recommended to properly handle all async tasks before returning a result as it could make your code unpredictable.

For example\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{\ setTimeout\ \}\ =\ require('timers/promises');}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ (\{\ a,\ b\ \})\ =>\ \{}
\DoxyCodeLine{\ \ //\ This\ promise\ should\ be\ awaited}
\DoxyCodeLine{\ \ setTimeout(1000).then(()\ =>\ \{}
\DoxyCodeLine{\ \ \ \ console.log('Working');\ //\ This\ will\ **not**\ run\ during\ the\ same\ worker\ call}
\DoxyCodeLine{\ \ \});}
\DoxyCodeLine{\ \ }
\DoxyCodeLine{\ \ return\ a\ +\ b;}
\DoxyCodeLine{\};}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16246}{}\doxysubsubsubsection{\texorpdfstring{Additional Examples}{Additional Examples}}\label{README.md_autotoc_md16246}
Additional examples can be found in the Git\+Hub repo at \href{https://github.com/piscinajs/piscina/tree/master/examples}{\texttt{ https\+://github.\+com/piscinajs/piscina/tree/master/examples}}\hypertarget{README.md_autotoc_md16247}{}\doxysubsubsection{\texorpdfstring{Class\+: {\ttfamily Piscina}}{Class\+: {\ttfamily Piscina}}}\label{README.md_autotoc_md16247}
Piscina works by creating a pool of Node.\+js Worker Threads to which one or more tasks may be dispatched. Each worker thread executes a single exported function defined in a separate file. Whenever a task is dispatched to a worker, the worker invokes the exported function and reports the return value back to Piscina when the function completes.

This class extends \href{https://nodejs.org/api/events.html}{\texttt{ {\ttfamily Event\+Emitter}}} from Node.\+js.\hypertarget{README.md_autotoc_md16248}{}\doxysubsubsubsection{\texorpdfstring{Constructor\+: {\ttfamily new Piscina(\mbox{[}options\mbox{]})}}{Constructor\+: {\ttfamily new Piscina(\mbox{[}options\mbox{]})}}}\label{README.md_autotoc_md16248}

\begin{DoxyItemize}
\item The following optional configuration is supported\+:
\begin{DoxyItemize}
\item {\ttfamily filename}\+: ({\ttfamily string \texorpdfstring{$\vert$}{|} null}) Provides the default source for the code that runs the tasks on Worker threads. This should be an absolute path or an absolute {\ttfamily \href{file://}{\texttt{ file\+://}}} URL to a file that exports a Java\+Script {\ttfamily function} or {\ttfamily async function} as its default export or {\ttfamily module.\+exports}. \href{https://nodejs.org/api/esm.html}{\texttt{ ES modules}} are supported.
\item {\ttfamily name}\+: ({\ttfamily string \texorpdfstring{$\vert$}{|} null}) Provides the name of the default exported worker function. The default is `\textquotesingle{}default'{\ttfamily , indicating the default export of the worker module. \texorpdfstring{$\ast$}{*}}min\+Threads{\ttfamily \+: (}number{\ttfamily ) Sets the minimum number of threads that are always running for this thread pool. The default is based on the number of available CPUs. \texorpdfstring{$\ast$}{*}}max\+Threads{\ttfamily \+: (}number{\ttfamily ) Sets the maximum number of threads that are running for this thread pool. The default is based on the number of available CPUs. \texorpdfstring{$\ast$}{*}}idle\+Timeout{\ttfamily \+: (}number{\ttfamily ) A timeout in milliseconds that specifies how long a}Worker{\ttfamily is allowed to be idle, i.\+e. not handling any tasks, before it is shut down. By default, this is immediate. \texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}\+Tip\texorpdfstring{$\ast$}{*}\texorpdfstring{$\ast$}{*}\+: \texorpdfstring{$\ast$}{*}\+The default}idle\+Timeout{\ttfamily  can lead to some performance loss in the application because of the overhead involved with stopping and starting new worker threads. To improve performance, try setting the}idle\+Timeout{\ttfamily explicitly.\texorpdfstring{$\ast$}{*} \texorpdfstring{$\ast$}{*}}max\+Queue{\ttfamily \+: (}number{\ttfamily \texorpdfstring{$\vert$}{|}}string{\ttfamily ) The maximum number of tasks that may be scheduled to run, but not yet running due to lack of available threads, at a given time. By default, there is no limit. The special value}\textquotesingle{}auto\textquotesingle{}{\ttfamily  may be used to have Piscina calculate the maximum as the square of}max\+Threads{\ttfamily . When}\textquotesingle{}auto\textquotesingle{}{\ttfamily is used, the calculated}max\+Queue{\ttfamily value may be found by checking the \mbox{[}}options.\+max\+Queue{\ttfamily \mbox{]}(\#property-\/options-\/readonly) property. \texorpdfstring{$\ast$}{*}}concurrent\+Tasks\+Per\+Worker{\ttfamily \+: (}number{\ttfamily ) Specifies how many tasks can share a single Worker thread simultaneously. The default is}1{\ttfamily . This generally only makes sense to specify if there is some kind of asynchronous component to the task. Keep in mind that Worker threads are generally not built for handling I/O in parallel. \texorpdfstring{$\ast$}{*}}use\+Atomics{\ttfamily \+: (}boolean{\ttfamily ) Use the \mbox{[}}Atomics{\ttfamily \mbox{]}\mbox{[}\mbox{]} API for faster communication between threads. This is on by default. You can disable}Atomics{\ttfamily globally by setting the environment variable}PISCINA\+\_\+\+DISABLE\+\_\+\+ATOMICS{\ttfamily to}1{\ttfamily . If}use\+Atomics{\ttfamily is}true{\ttfamily , it will cause to pause threads (stoping all execution) between tasks. Ideally, threads should wait for all operations to finish before returning control to the main thread (avoid having open handles within a thread). \texorpdfstring{$\ast$}{*}}resource\+Limits{\ttfamily \+: (}object{\ttfamily ) See \mbox{[}Node.\+js new Worker options\mbox{]}\mbox{[}\mbox{]} \texorpdfstring{$\ast$}{*}}max\+Old\+Generation\+Size\+Mb{\ttfamily \+: (}number{\ttfamily ) The maximum size of each worker threads main heap in MB. \texorpdfstring{$\ast$}{*}}max\+Young\+Generation\+Size\+Mb{\ttfamily \+: (}number{\ttfamily ) The maximum size of a heap space for recently created objects. \texorpdfstring{$\ast$}{*}}code\+Range\+Size\+Mb{\ttfamily \+: (}number{\ttfamily ) The size of a pre-\/allocated memory range used for generated code. \texorpdfstring{$\ast$}{*}}stack\+Size\+Mb{\ttfamily \+: (}number{\ttfamily ) The default maximum stack size for the thread. Small values may lead to unusable Worker instances. Default\+: 4 \texorpdfstring{$\ast$}{*}}env{\ttfamily \+: (}object{\ttfamily ) If set, specifies the initial value of}process.\+env{\ttfamily inside the worker threads. See \mbox{[}Node.\+js new Worker options\mbox{]}\mbox{[}\mbox{]} for details. \texorpdfstring{$\ast$}{*}}argv{\ttfamily \+: (}any\mbox{[}\mbox{]}{\ttfamily ) List of arguments that will be stringified and appended to }process.\+argv{\ttfamily in the worker. See \mbox{[}Node.\+js new Worker options\mbox{]}\mbox{[}\mbox{]} for details. \texorpdfstring{$\ast$}{*}}exec\+Argv{\ttfamily \+: (}string\mbox{[}\mbox{]}{\ttfamily ) List of Node.\+js CLI options passed to the worker. See \mbox{[}Node.\+js new Worker options\mbox{]}\mbox{[}\mbox{]} for details. \texorpdfstring{$\ast$}{*}}worker\+Data{\ttfamily \+: (}any{\ttfamily ) Any Java\+Script value that can be cloned and made available as}require(\textquotesingle{}piscina\textquotesingle{}).worker\+Data{\ttfamily . See \mbox{[}Node.\+js new Worker options\mbox{]}\mbox{[}\mbox{]} for details. Unlike regular Node.\+js Worker Threads,}worker\+Data{\ttfamily must not specify any value requiring a}transfer\+List{\ttfamily . This is because the}worker\+Data{\ttfamily  will be cloned for each pooled worker. \texorpdfstring{$\ast$}{*}}task\+Queue{\ttfamily \+: (}Task\+Queue{\ttfamily ) By default, Piscina uses a first-\/in-\/first-\/out queue for submitted tasks. The}task\+Queue{\ttfamily option can be used to provide an alternative implementation. See \mbox{[}Custom Task Queues\mbox{]}\mbox{[}\mbox{]} for additional detail. \texorpdfstring{$\ast$}{*}}nice\+Increment{\ttfamily \+: (}number{\ttfamily ) An optional value that decreases priority for the individual threads, i.\+e. the higher the value, the lower the priority of the Worker threads. This value is only used on Linux and requires the optional \mbox{[}}nice-\/napi{\ttfamily \mbox{]}\mbox{[}\mbox{]} module to be installed. See \mbox{[}}nice(2){\ttfamily \mbox{]}\mbox{[}\mbox{]} for more details. \texorpdfstring{$\ast$}{*}}track\+Unmanaged\+Fds{\ttfamily \+: (}boolean{\ttfamily ) An optional setting that, when}true{\ttfamily , will cause Workers to track file descriptors managed using}fs.\+open(){\ttfamily and }fs.\+close(){\ttfamily , and will close them automatically when the Worker exits. Defaults to}true\`{}. (This option is only supported on Node.\+js 12.\+19+ and all Node.\+js versions higher than 14.\+6.\+0).
\end{DoxyItemize}
\end{DoxyItemize}

Use caution when setting resource limits. Setting limits that are too low may result in the {\ttfamily Piscina} worker threads being unusable.\hypertarget{README.md_autotoc_md16249}{}\doxysubsubsubsection{\texorpdfstring{Method\+: {\ttfamily run(task\mbox{[}, options\mbox{]})}}{Method\+: {\ttfamily run(task\mbox{[}, options\mbox{]})}}}\label{README.md_autotoc_md16249}
Schedules a task to be run on a Worker thread.


\begin{DoxyItemize}
\item {\ttfamily task}\+: Any value. This will be passed to the function that is exported from {\ttfamily filename}.
\item {\ttfamily options}\+:
\begin{DoxyItemize}
\item {\ttfamily transfer\+List}\+: An optional lists of objects that is passed to \mbox{[}{\ttfamily post\+Message()}\mbox{]} when posting {\ttfamily task} to the Worker, which are transferred rather than cloned.
\item {\ttfamily filename}\+: Optionally overrides the {\ttfamily filename} option passed to the constructor for this task. If no {\ttfamily filename} was specified to the constructor, this is mandatory.
\item {\ttfamily name}\+: Optionally overrides the exported worker function used for the task.
\item {\ttfamily abort\+Signal}\+: An \mbox{[}{\ttfamily Abort\+Signal}\mbox{]}\mbox{[}\mbox{]} instance. If passed, this can be used to cancel a task. If the task is already running, the corresponding {\ttfamily Worker} thread will be stopped. (More generally, any {\ttfamily Event\+Emitter} or {\ttfamily Event\+Target} that emits `\textquotesingle{}abort'{\ttfamily  events can be passed here.) Abortable tasks cannot share threads regardless of the}concurrent\+Tasks\+Per\+Worker\`{} options.
\end{DoxyItemize}
\end{DoxyItemize}

This returns a {\ttfamily Promise} for the return value of the (async) function call made to the function exported from {\ttfamily filename}. If the (async) function throws an error, the returned {\ttfamily Promise} will be rejected with that error. If the task is aborted, the returned {\ttfamily Promise} is rejected with an error as well.\hypertarget{README.md_autotoc_md16250}{}\doxysubsubsubsection{\texorpdfstring{Method\+: {\ttfamily run\+Task(task\mbox{[}, transfer\+List\mbox{]}\mbox{[}, filename\mbox{]}\mbox{[}, abort\+Signal\mbox{]})}}{Method\+: {\ttfamily run\+Task(task\mbox{[}, transfer\+List\mbox{]}\mbox{[}, filename\mbox{]}\mbox{[}, abort\+Signal\mbox{]})}}}\label{README.md_autotoc_md16250}
{\bfseries{Deprecated}} -- Use {\ttfamily run(task, options)} instead.

Schedules a task to be run on a Worker thread.


\begin{DoxyItemize}
\item {\ttfamily task}\+: Any value. This will be passed to the function that is exported from {\ttfamily filename}.
\item {\ttfamily transfer\+List}\+: An optional lists of objects that is passed to \mbox{[}{\ttfamily post\+Message()}\mbox{]} when posting {\ttfamily task} to the Worker, which are transferred rather than cloned.
\item {\ttfamily filename}\+: Optionally overrides the {\ttfamily filename} option passed to the constructor for this task. If no {\ttfamily filename} was specified to the constructor, this is mandatory.
\item {\ttfamily abort\+Signal}\+: An \mbox{[}{\ttfamily Abort\+Signal}\mbox{]}\mbox{[}\mbox{]} instance. If passed, this can be used to cancel a task. If the task is already running, the corresponding {\ttfamily Worker} thread will be stopped. (More generally, any {\ttfamily Event\+Emitter} or {\ttfamily Event\+Target} that emits `\textquotesingle{}abort'{\ttfamily  events can be passed here.) Abortable tasks cannot share threads regardless of the}concurrent\+Tasks\+Per\+Worker\`{} options.
\end{DoxyItemize}

This returns a {\ttfamily Promise} for the return value of the (async) function call made to the function exported from {\ttfamily filename}. If the (async) function throws an error, the returned {\ttfamily Promise} will be rejected with that error. If the task is aborted, the returned {\ttfamily Promise} is rejected with an error as well.\hypertarget{README.md_autotoc_md16251}{}\doxysubsubsubsection{\texorpdfstring{Method\+: {\ttfamily destroy()}}{Method\+: {\ttfamily destroy()}}}\label{README.md_autotoc_md16251}
Stops all Workers and rejects all {\ttfamily Promise}s for pending tasks.

This returns a {\ttfamily Promise} that is fulfilled once all threads have stopped.\hypertarget{README.md_autotoc_md16252}{}\doxysubsubsubsection{\texorpdfstring{Event\+: `\textquotesingle{}error'\`{}}{Event\+: `\textquotesingle{}error'\`{}}}\label{README.md_autotoc_md16252}
An `\textquotesingle{}error'\`{} event is emitted by instances of this class when\+:


\begin{DoxyItemize}
\item Uncaught exceptions occur inside Worker threads that do not currently handle tasks.
\item Unexpected messages are sent from from Worker threads.
\end{DoxyItemize}

All other errors are reported by rejecting the {\ttfamily Promise} returned from {\ttfamily run()} or {\ttfamily run\+Task()}, including rejections reported by the handler function itself.\hypertarget{README.md_autotoc_md16253}{}\doxysubsubsubsection{\texorpdfstring{Event\+: `\textquotesingle{}drain'\`{}}{Event\+: `\textquotesingle{}drain'\`{}}}\label{README.md_autotoc_md16253}
A `\textquotesingle{}drain'{\ttfamily event is emitted whenever the}queue\+Size{\ttfamily reaches}0\`{}.\hypertarget{README.md_autotoc_md16254}{}\doxysubsubsubsection{\texorpdfstring{Event\+: `\textquotesingle{}needs\+Drain'\`{}}{Event\+: `\textquotesingle{}needs\+Drain'\`{}}}\label{README.md_autotoc_md16254}
Similar to \`{}\+Piscina\#needs\+Drain\`{}; this event is triggered once the total capacity of the pool is exceeded by number of tasks enequeued that are pending of execution.\hypertarget{README.md_autotoc_md16255}{}\doxysubsubsubsection{\texorpdfstring{Event\+: `\textquotesingle{}message'\`{}}{Event\+: `\textquotesingle{}message'\`{}}}\label{README.md_autotoc_md16255}
A `\textquotesingle{}message'\`{} event is emitted whenever a message is received from a worker thread.\hypertarget{README.md_autotoc_md16256}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily completed} (readonly)}{Property\+: {\ttfamily completed} (readonly)}}\label{README.md_autotoc_md16256}
The current number of completed tasks.\hypertarget{README.md_autotoc_md16257}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily duration} (readonly)}{Property\+: {\ttfamily duration} (readonly)}}\label{README.md_autotoc_md16257}
The length of time (in milliseconds) since this {\ttfamily Piscina} instance was created.\hypertarget{README.md_autotoc_md16258}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily options} (readonly)}{Property\+: {\ttfamily options} (readonly)}}\label{README.md_autotoc_md16258}
A copy of the options that are currently being used by this instance. This object has the same properties as the options object passed to the constructor.\hypertarget{README.md_autotoc_md16259}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily run\+Time} (readonly)}{Property\+: {\ttfamily run\+Time} (readonly)}}\label{README.md_autotoc_md16259}
A histogram summary object summarizing the collected run times of completed tasks. All values are expressed in milliseconds.


\begin{DoxyItemize}
\item {\ttfamily run\+Time.\+average} \{{\ttfamily number}\} The average run time of all tasks
\item {\ttfamily run\+Time.\+mean} \{{\ttfamily number}\} The mean run time of all tasks
\item {\ttfamily run\+Time.\+stddev} \{{\ttfamily number}\} The standard deviation of collected run times
\item {\ttfamily run\+Time.\+min} \{{\ttfamily number}\} The fastest recorded run time
\item {\ttfamily run\+Time.\+max} \{{\ttfamily number}\} The slowest recorded run time
\end{DoxyItemize}

All properties following the pattern {\ttfamily p\{N\}} where N is a number (e.\+g. {\ttfamily p1}, {\ttfamily p99}) represent the percentile distributions of run time observations. For example, {\ttfamily p99} is the 99th percentile indicating that 99\% of the observed run times were faster or equal to the given value.


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ average:\ 1880.25,}
\DoxyCodeLine{\ \ mean:\ 1880.25,}
\DoxyCodeLine{\ \ stddev:\ 1.93,}
\DoxyCodeLine{\ \ min:\ 1877,}
\DoxyCodeLine{\ \ max:\ 1882.0190887451172,}
\DoxyCodeLine{\ \ p0\_001:\ 1877,}
\DoxyCodeLine{\ \ p0\_01:\ 1877,}
\DoxyCodeLine{\ \ p0\_1:\ 1877,}
\DoxyCodeLine{\ \ p1:\ 1877,}
\DoxyCodeLine{\ \ p2\_5:\ 1877,}
\DoxyCodeLine{\ \ p10:\ 1877,}
\DoxyCodeLine{\ \ p25:\ 1877,}
\DoxyCodeLine{\ \ p50:\ 1881,}
\DoxyCodeLine{\ \ p75:\ 1881,}
\DoxyCodeLine{\ \ p90:\ 1882,}
\DoxyCodeLine{\ \ p97\_5:\ 1882,}
\DoxyCodeLine{\ \ p99:\ 1882,}
\DoxyCodeLine{\ \ p99\_9:\ 1882,}
\DoxyCodeLine{\ \ p99\_99:\ 1882,}
\DoxyCodeLine{\ \ p99\_999:\ 1882}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16260}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily threads} (readonly)}{Property\+: {\ttfamily threads} (readonly)}}\label{README.md_autotoc_md16260}
An Array of the {\ttfamily Worker} instances used by this pool.\hypertarget{README.md_autotoc_md16261}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily queue\+Size} (readonly)}{Property\+: {\ttfamily queue\+Size} (readonly)}}\label{README.md_autotoc_md16261}
The current number of tasks waiting to be assigned to a Worker thread.\hypertarget{README.md_autotoc_md16262}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily needs\+Drain} (readonly)}{Property\+: {\ttfamily needs\+Drain} (readonly)}}\label{README.md_autotoc_md16262}
Boolean value that specifies whether the capacity of the pool has been exceeded by the number of tasks submitted.

This property is helpful to make decisions towards creating backpressure over the number of tasks submitted to the pool.\hypertarget{README.md_autotoc_md16263}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily utilization} (readonly)}{Property\+: {\ttfamily utilization} (readonly)}}\label{README.md_autotoc_md16263}
A point-\/in-\/time ratio comparing the approximate total mean run time of completed tasks to the total runtime capacity of the pool.

A pools runtime capacity is determined by multiplying the {\ttfamily duration} by the {\ttfamily options.\+max\+Thread} count. This provides an absolute theoretical maximum aggregate compute time that the pool would be capable of.

The approximate total mean run time is determined by multiplying the mean run time of all completed tasks by the total number of completed tasks. This number represents the approximate amount of time the pool as been actively processing tasks.

The utilization is then calculated by dividing the approximate total mean run time by the capacity, yielding a fraction between {\ttfamily 0} and {\ttfamily 1}.\hypertarget{README.md_autotoc_md16264}{}\doxysubsubsubsection{\texorpdfstring{Property\+: {\ttfamily wait\+Time} (readonly)}{Property\+: {\ttfamily wait\+Time} (readonly)}}\label{README.md_autotoc_md16264}
A histogram summary object summarizing the collected times tasks spent waiting in the queue. All values are expressed in milliseconds.


\begin{DoxyItemize}
\item {\ttfamily wait\+Time.\+average} \{{\ttfamily number}\} The average wait time of all tasks
\item {\ttfamily wait\+Time.\+mean} \{{\ttfamily number}\} The mean wait time of all tasks
\item {\ttfamily wait\+Time.\+stddev} \{{\ttfamily number}\} The standard deviation of collected wait times
\item {\ttfamily wait\+Time.\+min} \{{\ttfamily number}\} The fastest recorded wait time
\item {\ttfamily wait\+Time.\+max} \{{\ttfamily number}\} The longest recorded wait time
\end{DoxyItemize}

All properties following the pattern {\ttfamily p\{N\}} where N is a number (e.\+g. {\ttfamily p1}, {\ttfamily p99}) represent the percentile distributions of wait time observations. For example, {\ttfamily p99} is the 99th percentile indicating that 99\% of the observed wait times were faster or equal to the given value.


\begin{DoxyCode}{0}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ average:\ 1880.25,}
\DoxyCodeLine{\ \ mean:\ 1880.25,}
\DoxyCodeLine{\ \ stddev:\ 1.93,}
\DoxyCodeLine{\ \ min:\ 1877,}
\DoxyCodeLine{\ \ max:\ 1882.0190887451172,}
\DoxyCodeLine{\ \ p0\_001:\ 1877,}
\DoxyCodeLine{\ \ p0\_01:\ 1877,}
\DoxyCodeLine{\ \ p0\_1:\ 1877,}
\DoxyCodeLine{\ \ p1:\ 1877,}
\DoxyCodeLine{\ \ p2\_5:\ 1877,}
\DoxyCodeLine{\ \ p10:\ 1877,}
\DoxyCodeLine{\ \ p25:\ 1877,}
\DoxyCodeLine{\ \ p50:\ 1881,}
\DoxyCodeLine{\ \ p75:\ 1881,}
\DoxyCodeLine{\ \ p90:\ 1882,}
\DoxyCodeLine{\ \ p97\_5:\ 1882,}
\DoxyCodeLine{\ \ p99:\ 1882,}
\DoxyCodeLine{\ \ p99\_9:\ 1882,}
\DoxyCodeLine{\ \ p99\_99:\ 1882,}
\DoxyCodeLine{\ \ p99\_999:\ 1882}
\DoxyCodeLine{\}}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16265}{}\doxysubsubsubsection{\texorpdfstring{Static property\+: {\ttfamily is\+Worker\+Thread} (readonly)}{Static property\+: {\ttfamily is\+Worker\+Thread} (readonly)}}\label{README.md_autotoc_md16265}
Is {\ttfamily true} if this code runs inside a {\ttfamily Piscina} threadpool as a Worker.\hypertarget{README.md_autotoc_md16266}{}\doxysubsubsubsection{\texorpdfstring{Static property\+: {\ttfamily version} (readonly)}{Static property\+: {\ttfamily version} (readonly)}}\label{README.md_autotoc_md16266}
Provides the current version of this library as a semver string.\hypertarget{README.md_autotoc_md16267}{}\doxysubsubsubsection{\texorpdfstring{Static method\+: {\ttfamily move(value)}}{Static method\+: {\ttfamily move(value)}}}\label{README.md_autotoc_md16267}
By default, any value returned by a worker function will be cloned when returned back to the Piscina pool, even if that object is capable of being transfered. The {\ttfamily Piscina.\+move()} method can be used to wrap and mark transferable values such that they will by transfered rather than cloned.

The {\ttfamily value} may be any object supported by Node.\+js to be transferable (e.\+g. {\ttfamily Array\+Buffer}, any {\ttfamily Typed\+Array}, or {\ttfamily Message\+Port}), or any object implementing the {\ttfamily Transferable} interface.


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{\ move\ \}\ =\ require('piscina');}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ ()\ =>\ \{}
\DoxyCodeLine{\ \ return\ move(new\ ArrayBuffer(10));}
\DoxyCodeLine{\}}

\end{DoxyCode}


The {\ttfamily move()} method will throw if the {\ttfamily value} is not transferable.

The object returned by the {\ttfamily move()} method should not be set as a nested value in an object. If it is used, the {\ttfamily move()} object itself will be cloned as opposed to transfering the object it wraps.\hypertarget{README.md_autotoc_md16268}{}\doxysubsubsubsubsection{\texorpdfstring{Interface\+: {\ttfamily Transferable}}{Interface\+: {\ttfamily Transferable}}}\label{README.md_autotoc_md16268}
Objects may implement the {\ttfamily Transferable} interface to create their own custom transferable objects. This is useful when an object being passed into or from a worker contains a deeply nested transferable object such as an {\ttfamily Array\+Buffer} or {\ttfamily Message\+Port}.

{\ttfamily Transferable} objects expose two properties inspected by Piscina to determine how to transfer the object. These properties are named using the special static {\ttfamily Piscina.\+transferable\+Symbol} and {\ttfamily Piscina.\+value\+Symbol} properties\+:


\begin{DoxyItemize}
\item The {\ttfamily Piscina.\+transferable\+Symbol} property provides the object (or objects) that are to be included in the {\ttfamily transfer\+List}.
\item The {\ttfamily Piscina.\+value\+Symbol} property provides a surrogate value to transmit in place of the {\ttfamily Transferable} itself.
\end{DoxyItemize}

Both properties are required.

For example,


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ \{}
\DoxyCodeLine{\ \ move,}
\DoxyCodeLine{\ \ transferableSymbol,}
\DoxyCodeLine{\ \ valueSymbol}
\DoxyCodeLine{\}\ =\ require('piscina');}
\DoxyCodeLine{}
\DoxyCodeLine{module.exports\ =\ ()\ =>\ \{}
\DoxyCodeLine{\ \ const\ obj\ =\ \{}
\DoxyCodeLine{\ \ \ \ a:\ \{\ b:\ new\ Uint8Array(5);\ \},}
\DoxyCodeLine{\ \ \ \ c:\ \{\ new\ Uint8Array(10);\ \},}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ get\ [transferableSymbol]()\ \{}
\DoxyCodeLine{\ \ \ \ \ \ //\ Transfer\ the\ two\ underlying\ ArrayBuffers}
\DoxyCodeLine{\ \ \ \ \ \ return\ [this.a.b.buffer,\ this.c.buffer];}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ get\ [valueSymbol]()\ \{}
\DoxyCodeLine{\ \ \ \ \ \ return\ \{\ a:\ \{\ b:\ this.a.b\ \},\ c:\ this.c\ \};}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\ \ \};}
\DoxyCodeLine{\ \ return\ move(obj);}
\DoxyCodeLine{\};}

\end{DoxyCode}
\hypertarget{README.md_autotoc_md16269}{}\doxysubsubsection{\texorpdfstring{Custom Task Queues}{Custom Task Queues}}\label{README.md_autotoc_md16269}
By default, Piscina uses a simple array-\/based first-\/in-\/first-\/out (fifo) task queue. When a new task is submitted and there are no available workers, tasks are pushed on to the queue until a worker becomes available.

If the default fifo queue is not sufficient, user code may replace the task queue implementation with a custom implementation using the {\ttfamily task\+Queue} option on the Piscina constructor.

Custom task queue objects {\itshape must} implement the {\ttfamily Task\+Queue} interface, described below using Type\+Script syntax\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{interface\ Task\ \{}
\DoxyCodeLine{\ \ readonly\ [Piscina.queueOptionsSymbol]\ :\ object\ |\ null;}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{interface\ TaskQueue\ \{}
\DoxyCodeLine{\ \ readonly\ size\ :\ number;}
\DoxyCodeLine{\ \ shift\ ()\ :\ Task\ |\ null;}
\DoxyCodeLine{\ \ remove\ (task\ :\ Task)\ :\ void;}
\DoxyCodeLine{\ \ push\ (task\ :\ Task)\ :\ void;}
\DoxyCodeLine{\}}

\end{DoxyCode}


An example of a custom task queue that uses a shuffled priority queue is available in \href{./examples/task-queue/index.js}{\texttt{ {\ttfamily examples/task-\/queue}}};

The special symbol {\ttfamily Piscina.\+queue\+Options\+Symbol} may be set as a property on tasks submitted to {\ttfamily run()} or {\ttfamily run\+Task()} as a way of passing additional options on to the custom {\ttfamily Task\+Queue} implementation. (Note that because the queue options are set as a property on the task, tasks with queue options cannot be submitted as Java\+Script primitives).\hypertarget{README.md_autotoc_md16270}{}\doxysubsubsection{\texorpdfstring{Current Limitations (Things we\textquotesingle{}re working on / would love help with)}{Current Limitations (Things we\textquotesingle{}re working on / would love help with)}}\label{README.md_autotoc_md16270}

\begin{DoxyItemize}
\item Improved Documentation
\item Benchmarks
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16271}{}\doxysubsubsection{\texorpdfstring{Performance Notes}{Performance Notes}}\label{README.md_autotoc_md16271}
Workers are generally optimized for offloading synchronous, compute-\/intensive operations off the main Node.\+js event loop thread. While it is possible to perform asynchronous operations and I/O within a Worker, the performance advantages of doing so will be minimal.

Specifically, it is worth noting that asynchronous operations within Node.\+js, including I/O such as file system operations or CPU-\/bound tasks such as crypto operations or compression algorithms, are already performed in parallel by Node.\+js and libuv on a per-\/process level. This means that there will be little performance impact on moving such async operations into a Piscina worker (see examples/scrypt for example).\hypertarget{README.md_autotoc_md16272}{}\doxysubsubsubsection{\texorpdfstring{Queue Size}{Queue Size}}\label{README.md_autotoc_md16272}
Piscina provides the ability to configure the minimum and maximum number of worker threads active in the pool, as well as set limits on the number of tasks that may be queued up waiting for a free worker. It is important to note that setting the {\ttfamily max\+Queue} size too high relative to the number of worker threads can have a detrimental impact on performance and memory usage. Setting the {\ttfamily max\+Queue} size too small can also be problematic as doing so could cause your worker threads to become idle and be shutdown. Our testing has shown that a {\ttfamily max\+Queue} size of approximately the square of the maximum number of threads is generally sufficient and performs well for many cases, but this will vary significantly depending on your workload. It will be important to test and benchmark your worker pools to ensure you\textquotesingle{}ve effectively balanced queue wait times, memory usage, and worker pool utilization.\hypertarget{README.md_autotoc_md16273}{}\doxysubsubsubsection{\texorpdfstring{Queue Pressure and Idle Threads}{Queue Pressure and Idle Threads}}\label{README.md_autotoc_md16273}
The thread pool maintained by Piscina has both a minimum and maximum limit to the number of threads that may be created. When a Piscina instance is created, it will spawn the minimum number of threads immediately, then create additional threads as needed up to the limit set by {\ttfamily max\+Threads}. Whenever a worker completes a task, a check is made to determine if there is additional work for it to perform. If there is no additional work, the thread is marked idle. By default, idle threads are shutdown immediately, with Piscina ensuring that the pool always maintains at least the minimum.

When a Piscina pool is processing a stream of tasks (for instance, processing http server requests as in the React server-\/side rendering example in examples/react-\/ssr), if the rate in which new tasks are received and queued is not sufficient to keep workers from going idle and terminating, the pool can experience a thrashing effect -- excessively creating and terminating workers that will cause a net performance loss. There are a couple of strategies to avoid this churn\+:

Strategy 1\+: Ensure that the queue rate of new tasks is sufficient to keep workers from going idle. We refer to this as "{}queue pressure"{}. If the queue pressure is too low, workers will go idle and terminate. If the queue pressure is too high, tasks will stack up, experience increased wait latency, and consume additional memory.

Strategy 2\+: Increase the {\ttfamily idle\+Timeout} configuration option. By default, idle threads terminate immediately. The {\ttfamily idle\+Timeout} option can be used to specify a longer period of time to wait for additional tasks to be submitted before terminating the worker. If the queue pressure is not maintained, this could result in workers sitting idle but those will have less of a performance impact than the thrashing that occurs when threads are repeatedly terminated and recreated.

Strategy 3\+: Increase the {\ttfamily min\+Threads} configuration option. This has the same basic effect as increasing the {\ttfamily idle\+Timeout}. If the queue pressure is not high enough, workers may sit idle indefinitely but there will be less of a performance hit.

In applications using Piscina, it will be most effective to use a combination of these three approaches and tune the various configuration parameters to find the optimum combination both for the application workload and the capabilities of the deployment environment. There are no one set of options that are going to work best.\hypertarget{README.md_autotoc_md16274}{}\doxysubsubsubsection{\texorpdfstring{Thread priority on Linux systems}{Thread priority on Linux systems}}\label{README.md_autotoc_md16274}
On Linux systems that support \href{https://linux.die.net/man/2/nice}{\texttt{ {\ttfamily nice(2)}}}, Piscina is capable of setting the priority of every worker in the pool. To use this mechanism, an additional optional native addon dependency ({\ttfamily nice-\/napi}, {\ttfamily npm i nice-\/napi}) is required. Once \href{https://npmjs.org/package/nice-napi}{\texttt{ {\ttfamily nice-\/napi}}} is installed, creating a {\ttfamily Piscina} instance with the {\ttfamily nice\+Increment} configuration option will set the priority for the pool\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{const\ Piscina\ =\ require('piscina');}
\DoxyCodeLine{const\ pool\ =\ new\ Piscina(\{}
\DoxyCodeLine{\ \ worker:\ '/absolute/path/to/worker.js',}
\DoxyCodeLine{\ \ niceIncrement:\ 20}
\DoxyCodeLine{\});}

\end{DoxyCode}


The higher the {\ttfamily nice\+Increment}, the lower the CPU scheduling priority will be for the pooled workers which will generally extend the execution time of CPU-\/bound tasks but will help prevent those threads from stealing CPU time from the main Node.\+js event loop thread. Whether this is a good thing or not depends entirely on your application and will require careful profiling to get correct.

The key metrics to pay attention to when tuning the {\ttfamily nice\+Increment} are the sampled run times of the tasks in the worker pool (using the \`{}run\+Time\`{} property) and the \href{https://nodejs.org/dist/latest-v14.x/docs/api/perf_hooks.html\#perf_hooks_perf_hooks_monitoreventloopdelay_options}{\texttt{ delay of the Node.\+js main thread event loop}}.\hypertarget{README.md_autotoc_md16275}{}\doxysubsubsubsection{\texorpdfstring{Multiple Thread Pools and Embedding Piscina as a Dependency}{Multiple Thread Pools and Embedding Piscina as a Dependency}}\label{README.md_autotoc_md16275}
Every {\ttfamily Piscina} instance creates a separate pool of threads and operates without any awareness of the other. When multiple pools are created in a single application the various threads may contend with one another, and with the Node.\+js main event loop thread, and may cause an overall reduction in system performance.

Modules that embed Piscina as a dependency {\itshape should} make it clear via documentation that threads are being used. It would be ideal if those would make it possible for users to provide an existing {\ttfamily Piscina} instance as a configuration option in lieu of always creating their own.\hypertarget{README.md_autotoc_md16276}{}\doxysubsubsection{\texorpdfstring{Release Notes}{Release Notes}}\label{README.md_autotoc_md16276}
\hypertarget{README.md_autotoc_md16277}{}\doxysubsubsubsection{\texorpdfstring{4.\+1.\+0}{4.\+1.\+0}}\label{README.md_autotoc_md16277}
\hypertarget{README.md_autotoc_md16278}{}\doxysubsubsubsubsection{\texorpdfstring{Features}{Features}}\label{README.md_autotoc_md16278}

\begin{DoxyItemize}
\item add {\ttfamily needs\+Drain} property (\href{https://github.com/piscinajs/piscina/issues/368}{\texttt{ \#368}}) (\href{https://github.com/piscinajs/piscina/commit/2d49b63368116c172a52e2019648049b4d280162}{\texttt{ 2d49b63}})
\item correctly handle process.\+exit calls outside of a task (\href{https://github.com/piscinajs/piscina/issues/361}{\texttt{ \#361}}) (\href{https://github.com/piscinajs/piscina/commit/8e6d16e1dc23f8bb39772ed954f6689852ad435f}{\texttt{ 8e6d16e}})
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16279}{}\doxysubsubsubsubsection{\texorpdfstring{Bug Fixes}{Bug Fixes}}\label{README.md_autotoc_md16279}

\begin{DoxyItemize}
\item Fix types for Type\+Script 4.\+7 (\href{https://github.com/piscinajs/piscina/issues/239}{\texttt{ \#239}}) (\href{https://github.com/piscinajs/piscina/commit/a38fb292e8fcc45cc20abab8668f82d908a24dc0}{\texttt{ a38fb29}})
\item use CJS imports (\href{https://github.com/piscinajs/piscina/issues/374}{\texttt{ \#374}}) (\href{https://github.com/piscinajs/piscina/commit/edf8dc4f1a19e9b49e266109cdb70d9acc86f3ca}{\texttt{ edf8dc4}})
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16280}{}\doxysubsubsubsection{\texorpdfstring{4.\+0.\+0}{4.\+0.\+0}}\label{README.md_autotoc_md16280}

\begin{DoxyItemize}
\item Drop Node.\+js 14.\+x support
\item Add Node.\+js 20.\+x to CI
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16281}{}\doxysubsubsubsection{\texorpdfstring{3.\+2.\+0}{3.\+2.\+0}}\label{README.md_autotoc_md16281}

\begin{DoxyItemize}
\item Adds a new {\ttfamily PISCINA\+\_\+\+DISABLE\+\_\+\+ATOMICS} environment variable as an alternative way of disabling Piscina\textquotesingle{}s internal use of the {\ttfamily Atomics} API. (\href{https://github.com/piscinajs/piscina/pull/163}{\texttt{ https\+://github.\+com/piscinajs/piscina/pull/163}})
\item Fixes a bug with transferable objects. (\href{https://github.com/piscinajs/piscina/pull/155}{\texttt{ https\+://github.\+com/piscinajs/piscina/pull/155}})
\item Fixes CI issues with Type\+Script. (\href{https://github.com/piscinajs/piscina/pull/161}{\texttt{ https\+://github.\+com/piscinajs/piscina/pull/161}})
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16282}{}\doxysubsubsubsection{\texorpdfstring{3.\+1.\+0}{3.\+1.\+0}}\label{README.md_autotoc_md16282}

\begin{DoxyItemize}
\item Deprecates {\ttfamily piscina.\+run\+Task()}; adds {\ttfamily piscina.\+run()} as an alternative. \href{https://github.com/piscinajs/piscina/commit/d7fa24d7515789001f7237ad6ae9ad42d582fc75}{\texttt{ https\+://github.\+com/piscinajs/piscina/commit/d7fa24d7515789001f7237ad6ae9ad42d582fc75}}
\item Allows multiple exported handler functions from a single file. \href{https://github.com/piscinajs/piscina/commit/d7fa24d7515789001f7237ad6ae9ad42d582fc75}{\texttt{ https\+://github.\+com/piscinajs/piscina/commit/d7fa24d7515789001f7237ad6ae9ad42d582fc75}}
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16283}{}\doxysubsubsubsection{\texorpdfstring{3.\+0.\+0}{3.\+0.\+0}}\label{README.md_autotoc_md16283}

\begin{DoxyItemize}
\item Drops Node.\+js 10.\+x support
\item Updates minimum Type\+Script target to ES2019
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16284}{}\doxysubsubsubsection{\texorpdfstring{2.\+1.\+0}{2.\+1.\+0}}\label{README.md_autotoc_md16284}

\begin{DoxyItemize}
\item Adds name property to indicate {\ttfamily Abort\+Error} when tasks are canceled using an {\ttfamily Abort\+Controller} (or similar)
\item More examples
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16285}{}\doxysubsubsubsection{\texorpdfstring{2.\+0.\+0}{2.\+0.\+0}}\label{README.md_autotoc_md16285}

\begin{DoxyItemize}
\item Added unmanaged file descriptor tracking
\item Updated dependencies
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16286}{}\doxysubsubsubsection{\texorpdfstring{1.\+6.\+1}{1.\+6.\+1}}\label{README.md_autotoc_md16286}

\begin{DoxyItemize}
\item Bug fix\+: Reject if Abort\+Signal is already aborted
\item Bug Fix\+: Use once listener for abort event
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16287}{}\doxysubsubsubsection{\texorpdfstring{1.\+6.\+0}{1.\+6.\+0}}\label{README.md_autotoc_md16287}

\begin{DoxyItemize}
\item Add the {\ttfamily nice\+Increment} configuration parameter.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16288}{}\doxysubsubsubsection{\texorpdfstring{1.\+5.\+1}{1.\+5.\+1}}\label{README.md_autotoc_md16288}

\begin{DoxyItemize}
\item Bug fixes around abortable task selection.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16289}{}\doxysubsubsubsection{\texorpdfstring{1.\+5.\+0}{1.\+5.\+0}}\label{README.md_autotoc_md16289}

\begin{DoxyItemize}
\item Added {\ttfamily Piscina.\+move()}
\item Added Custom Task Queues
\item Added utilization metric
\item Wait for workers to be ready before considering them as candidates
\item Additional examples
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16290}{}\doxysubsubsubsection{\texorpdfstring{1.\+4.\+0}{1.\+4.\+0}}\label{README.md_autotoc_md16290}

\begin{DoxyItemize}
\item Added `max\+Queue = \textquotesingle{}auto'\`{} to autocalculate the maximum queue size.
\item Added more examples, including an example of implementing a worker as a Node.\+js native addon.
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16291}{}\doxysubsubsubsection{\texorpdfstring{1.\+3.\+0}{1.\+3.\+0}}\label{README.md_autotoc_md16291}

\begin{DoxyItemize}
\item Added the `\textquotesingle{}drain'\`{} event
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16292}{}\doxysubsubsubsection{\texorpdfstring{1.\+2.\+0}{1.\+2.\+0}}\label{README.md_autotoc_md16292}

\begin{DoxyItemize}
\item Added support for ESM and \href{file://}{\texttt{ file\+://}} URLs
\item Added {\ttfamily env}, {\ttfamily argv}, {\ttfamily exec\+Argv}, and {\ttfamily worker\+Data} options
\item More examples
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16293}{}\doxysubsubsubsection{\texorpdfstring{1.\+1.\+0}{1.\+1.\+0}}\label{README.md_autotoc_md16293}

\begin{DoxyItemize}
\item Added support for Worker Thread {\ttfamily resource\+Limits}
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16294}{}\doxysubsubsubsection{\texorpdfstring{1.\+0.\+0}{1.\+0.\+0}}\label{README.md_autotoc_md16294}

\begin{DoxyItemize}
\item Initial release!
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16295}{}\doxysubsubsection{\texorpdfstring{The Team}{The Team}}\label{README.md_autotoc_md16295}

\begin{DoxyItemize}
\item James M Snell \href{mailto:jasnell@gmail.com}{\texttt{ jasnell@gmail.\+com}}
\item Anna Henningsen \href{mailto:anna@addaleax.net}{\texttt{ anna@addaleax.\+net}}
\item Matteo Collina \href{mailto:matteo.collina@gmail.com}{\texttt{ matteo.\+collina@gmail.\+com}}
\end{DoxyItemize}\hypertarget{README.md_autotoc_md16296}{}\doxysubsubsection{\texorpdfstring{Acknowledgements}{Acknowledgements}}\label{README.md_autotoc_md16296}
Piscina development is sponsored by \href{https://www.nearform.com/research/}{\texttt{ Near\+Form Research}}. 